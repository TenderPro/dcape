
## Работа СУБД в составе dcape и использование ее для разворачиваемых приложений

СУБД запускается в контейнере с именем `$PROJECT_NAME_db_1`.

### Резервирование и восстановление баз данных

Проектом [dcape-app-pg-backup](https://github.com/dopos/dcape-app-pg-backup) для БД
реализованы автоматические механизмы резервирования баз данных путем создания дампов
в каталоге `./var/data/db-backup`. де `./` - это каталог установки dcape.
Каталог для хранения дампов указывается при старте контейнера Postgres
в переменной `DCAPE_DB_DUMP_DEST`.

### Обновление версии Postgres

Обновление Postgres выполняется двумя способами:

* облегченный, без применения специальных инструментов - остановка контейнера,
переключение в конфиге `.env` настройки на новый образ и запуск контейнера - выполняется при
обновлении корректирующих (minor) версий Postgres;

* основной, с применением специальных инструментов pg_upgrade или pg_dumpall-psql -
при обновлении основных (major) версий Postgres.

#### Обновление основной версии при помощи pg_upgrade.

Для обновления основной версии Postgres используется проект [docker-postgres-upgrade](https://github.com/tianon/docker-postgres-upgrade)

Прежде, необходимо остановить Postgres, это можно сделать
через остановку сервиса БД (db) или через остановку всех сервисов dcape
(все команды запускаются в каталоге установки dcape):
```
# для остановки сервиса БД
 make dc CMD="rm -f -s db"
# для остановки dcape
 make down  
```
После остановки Postgres, изменяем на новое имя образа Postgres - `ИМЯ:ТЕГ`
в переменной `PG_IMAGE` файле конфига `.env`.

Запускаем обновление (выполнять с правами администратора):
```
 make pg_upgrade
```
При обновлении данные старой версии Postgres перемещаются в каталог `./var/data/db_$NUM_PG_OLD`,
данные новой версии записываются в `./var/data/db`. В случае необходимости, можно оперативно
переключить Postgres на старую версию.

В новой версии используются файлы конфигурации (копируются: pg_hba.conf и postgresql.conf)
со старой версии. В случае необходимости, отредактируйте конфигурационные файлы.

Запускаем сервис БД, тем способом, который был использован для остановки:
```
 # для запуска сервиса БД (db)
 make dc CMD="up -d db"
 # для запуска dcape
 make up
```

#### Обновление основной версии при помощи pg_dumpall-psql.

Обнолвение выполняется через создание дампа всего кластера Postgres и последующей его загрузки
в новую версию. Последовательность выполнения (команды выполняются в каталоге установки dcape, с правами администратора):

- создать дамп
```
 make pg_dumpall
```

- остановить сервис БД (через остановку сервиса БД (db) или через остановку всех сервисов dcape)
```
# для остановки сервиса БД
 make dc CMD="rm -f -s db"
# для остановки dcape
 make down  
```

- удалить данные из каталога БД
```
 rm -r ./var/data/db/*
```

- изменить на новое имя образа Postgres - `ИМЯ:ТЕГ` в переменной `PG_IMAGE` файле конфига `.env`
- при необходимости, внести изменения в настройки БД, которые находятся в: db-conf.d; db-init
- запустить сервис БД тем способом, который был использован для остановки
```
 # для запуска сервиса БД (db)
 make dc CMD="up -d db"
 # для запуска dcape
 make up
```
- загрузить дамп кластера Postgres
```
 make pg_load_dumpall
```
