
# Работа СУБД в составе dcape и использование ее для разворачиваемых приложений

СУБД запускается в контейнере с именем `$PROJECT_NAME_db_1`.

# Резервирование и восстановление баз данных

Проектом [dcape-app-pg-backup](https://github.com/dopos/dcape-app-pg-backup) для БД
реализованы автоматические механизмы резервирования баз данных путем создания дампов
в каталоге `$PWD/var/data/db_$PG_VER-backup`. Каталог для хранения дампов указывается
при старте контейнера Postgres в переменной `DCAPE_DB_DUMP_DEST`.
Где $PWD - это каталог установки dcape.

# Обновление версии Postgres

## Вариант с pg_upgrade.

Для обновления версии Postgres по этому варианту используется проект [docker-postgres-upgrade](https://github.com/tianon/docker-postgres-upgrade)

Перед началом обновления, необходимо (все команды запускаются в каталоге установки dcape):
```
# остановить контейнер postgres
 make dc CMD="rm -f -s [имя контенера postgres]"
# или остановить dcape
 make down  
```
Имя контейнера postgres формирутеся так: $PROJECT_NAME_db_1, где $PROJECT_NAME -
имя проекта, указанное в файле .env (задавать явно, переменные в оболочке не объявлены
и исполльзуются только внутри make и docker-compose)

При использовании этого варианта необходимо задать значения двух переменных `PG_VER` и `PG_NEW_VER`.
Они используются как указатели тега контейнера `postgres-upgrade:$PG_VER-to-$PG_NEW_VER`,
поэтому их значения нужно выбирать из номеров, которые используются в тегах этого образа.

Каталог хранения данных Postgres на диске `$PWD/var/data/db_$PG_VER` содержит в себе номер
используемой версии Postgres. В процессе обновления создается новый каталог
`$PWD/var/data/db_$PG_NEW_VER` и в него сохраняются данные, сконвертированные под
формат новой версии Postgres.

Значения переменных указывается в файле .env каталога установки dcape ($PWD).
Для запуска обновления:
```
 make pg_upgrade
```
Если обновление прошло успешно, необходимо изменить значение $PG_VER на новую версию,
значение $PG_NEW_VER убрать. При использовании нестандартных docker образов
Postgres, возможно понадобится корректировка имени образа (зависит от способа указание имени образа в .env).

После обновления необходимо проверить настройки доступа в файле `pg_hba.conf`.
Убрать доступ для всех из локальной сети и добавить доступ по md5.

Запускаем тот сервис, который был остановлен перед обновлением:
```
 # для запуска контейнера
 make dc CMD="up -d [имя контейнера postgres]"
 # для запуска dcape
 make up
```
