# Интеграция приложения в dcape

Для развернутого dcape известна следующая информация
* хост фронтенда dcape (например, cis.dev.lan)
* публичный ключ сервиса деплоя (доступен по ссылке на cis.dev.lan)
* пароль, который должен быть передан в хуке (задан в конфиге dcape)

## Порядок действий по интеграции приложения в dcape

* добавить в репозиторий файлы Makefile и docker-compose.yml ([примеры](https://github.com/dopos?q=dcape-app))
* настроить в gitea "Автоматическое обновление"
* выполнить тестовую доставку для сохранения .env в хранилище конфигураций
* выгрузить конфигурацию, активировать деплой в параметре `_CI_HOOK_ENABLED`, сохранить

### Настройка проекта в gitea

* добавить ключ развертывания (ссылка есть на cis.dev.lan)
* создать хук gitea с паролем из настроек dcape и ссылкой на хук
* выполнить тестовую доставку (будет склонирован репозиторий, выполнен `make .env` и файл .env помещен в хранилище)
* выгрузить конфигурацию, 

### Параметры хука в gitea

* URL хука: если gitea и dcape на одном хосте - `http://webhook:9000/hooks/local?branch=default`, иначе - `https://cis.dev.lan/hooks/remote?branch=default`
  * события хука: Push, Create

параметр `branch=default` произвести деплой (или удаление) копии приложения без внесения изменений в репозиторий проекта. 
Достаточно изменить defaul на нужное имя ветки или тега и выполнить проверку доставки

[Описание алгоритма деплоя](https://github.com/dopos/dockerfile-webhook/blob/master/webhook/README.md)
