# Интеграция приложения в dcape

Для развернутого dcape известна следующая информация
* хост фронтенда dcape (например, cis.dev.lan)
* публичный ключ сервиса деплоя (доступен по ссылке на cis.dev.lan)
* пароль, который должен быть передан в хуке (задан в конфиге dcape)

## Порядок действий по интеграции приложения в dcape

* Для [стороннего приложения](https://github.com/dopos?q=dcape-app): создать зеркало в gitea
* Для своего проекта: добавить в репозиторий файлы Makefile и docker-compose.yml ([примеры](https://github.com/dopos?q=dcape-app))
* настроить в gitea "Автоматическое обновление"
* выполнить тестовую доставку для сохранения .env в хранилище конфигураций
* выгрузить конфигурацию, активировать деплой в параметре `_CI_HOOK_ENABLED`, сохранить
* поаторить тестовую доставку или сделать `git push` - приложение будет развернуто на сервере dcape

### Настройка автоматического обновления в gitea

* добавить ключ развертывания (ссылка есть на cis.dev.lan)
* создать хук gitea с паролем из настроек dcape и ссылкой на хук
* URL хука: если gitea и dcape на одном хосте - `http://webhook:9000/hooks/local?branch=default`, иначе - `https://cis.dev.lan/hooks/remote?branch=default`
  * события хука: Push, Create

Параметр `branch=default` позволяет произвести деплой (или удаление) копии приложения без внесения изменений в репозиторий проекта.
Достаточно изменить default на нужное имя ветки или тега и выполнить проверку доставки.

См. также: [Описание алгоритма деплоя](https://github.com/dopos/dockerfile-webhook/blob/master/webhook/README.md)

## Информация для разработчика

### Отличия локальной копии dcape от сервера деплоя

Локально можно развернуть полный аналог iac (в dcape есть gitea - его можно развернуть, настроить как upstream, туда пушить и наблюдать локально весь процесс деплоя).
А если локальный ip доступен снаружи, можно завести dcape на порт 80 и включить https.

Т.е. отличие только в том, что не получится использовать по https те же доменные имена, что и на сервере, т.к. у локального хоста другой ip.

### Если в Makefile изменили шаблон создания .env

Чтобы сгенерить новый `.env`, не потеряв настройки из старого, надо старый переименовать в `.env.bak` и выполнить `make .env` - значения совпадающих переменных будут перенесены в новый конфиг.

Это достигается помещением в Makefile строк
```
-include $(CFG).bak
-include $(CFG)
export
```

### Удаление деплоя

Чтобы удалить на сервере контейнер и каталог деплоя проекта для ветки BRANCH, надо создать ветку BRANCH-rm.
Другой вариант - если в проект никто не пушит, можно в хуке поменять default на BRANCH-rm и выполнить "Проверить доставку", после чего вернуть default.

Реакция хука на создание ветки с суффиксом "-rm" - выполнить `make stop` и удалить каталог деплоя (конфиг сохраняется).
